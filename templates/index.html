<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AURA - Multi-Agent Voice Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <style>
    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    .pulse-ring {
      animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .message-appear {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .agent-avatar {
      transition: all 0.3s ease;
    }
    .agent-avatar:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
  
  <!-- Main Container -->
  <div class="w-full max-w-4xl h-[95vh] flex flex-col">
    
    <!-- Header -->
    <div class="glass-effect rounded-t-2xl p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-white flex items-center gap-3">
            <span class="text-4xl floating">üé≠</span>
            <span>AURA Assistant</span>
          </h1>
          <p class="text-purple-200 text-sm mt-1">Multi-Agent AI Voice Interface</p>
        </div>
        <div id="timer-display" class="hidden text-right">
          <div class="text-sm text-purple-200">Time Remaining</div>
          <div id="timer" class="text-2xl font-bold text-white">--:--</div>
        </div>
      </div>
    </div>

    <!-- Scenario Selection Screen -->
    <div id="scenario-screen" class="flex-grow glass-effect rounded-b-2xl p-8 flex flex-col justify-center items-center">
      <h2 class="text-2xl font-bold text-white mb-6">Select Your Room</h2>
      <div id="room-selection" class="w-full max-w-md space-y-3"></div>
    </div>

    <!-- Conversation Screen -->
    <div id="conversation-screen" class="hidden flex-grow glass-effect rounded-b-2xl flex flex-col overflow-hidden">
      
      <!-- Active Agents Display -->
      <div id="agents-display" class="p-4 border-b border-white/10">
        <div class="flex items-center gap-2 text-sm text-purple-200 mb-2">
          <span>Active Agents:</span>
        </div>
        <div id="agents-list" class="flex gap-3"></div>
      </div>

      <!-- Conversation Log -->
      <div id="conversation-log" class="flex-grow overflow-y-auto p-6 space-y-4"></div>

      <!-- Input Area -->
      <div class="p-6 border-t border-white/10 bg-black/20">
        <div class="flex flex-col items-center">
          <div id="status-message" class="text-purple-200 mb-4 text-center h-6 text-sm"></div>
          
          <!-- Recording Orb -->
          <div class="relative">
            <div id="pulse-ring" class="absolute inset-0 rounded-full bg-blue-400 opacity-0"></div>
            <div id="record-orb" class="relative w-24 h-24 bg-gradient-to-br from-blue-400 to-blue-600 hover:from-blue-500 hover:to-blue-700 rounded-full flex items-center justify-center cursor-pointer transition-all shadow-2xl text-4xl select-none z-10">
              üé§
            </div>
          </div>
          
          <div class="text-xs text-purple-300 mt-3 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            Hold to record your message
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const roomSelection = document.getElementById("room-selection");
    const scenarioScreen = document.getElementById("scenario-screen");
    const conversationScreen = document.getElementById("conversation-screen");
    const conversationLog = document.getElementById("conversation-log");
    const recordOrb = document.getElementById("record-orb");
    const pulseRing = document.getElementById("pulse-ring");
    const statusMessage = document.getElementById("status-message");
    const agentsList = document.getElementById("agents-list");
    const timerDisplay = document.getElementById("timer-display");
    const timerElement = document.getElementById("timer");

    let mediaRecorder, audioChunks = [], isRecording = false;
    let audioQueue = [];
    let isPlayingAudio = false;
    let currentAgents = [];
    let sessionEndTime = null;

    // Agent color mapping
    const agentColors = {
      'Coach': { bg: 'bg-red-500', text: 'text-red-100', border: 'border-red-400' },
      'Guide': { bg: 'bg-green-500', text: 'text-green-100', border: 'border-green-400' },
      'Mentor': { bg: 'bg-blue-500', text: 'text-blue-100', border: 'border-blue-400' },
      'Advisor': { bg: 'bg-yellow-500', text: 'text-yellow-100', border: 'border-yellow-400' },
      'Expert': { bg: 'bg-purple-500', text: 'text-purple-100', border: 'border-purple-400' },
      'Analyst': { bg: 'bg-indigo-500', text: 'text-indigo-100', border: 'border-indigo-400' },
      'Strategist': { bg: 'bg-pink-500', text: 'text-pink-100', border: 'border-pink-400' }
    };

    // Agent emoji mapping
    const agentEmojis = {
      'Coach': 'üèãÔ∏è',
      'Guide': 'üß≠',
      'Mentor': 'üë®‚Äçüè´',
      'Advisor': 'üíº',
      'Expert': 'üéì',
      'Analyst': 'üìä',
      'Strategist': '‚ôüÔ∏è'
    };

    // Get agent styling
    function getAgentStyle(agentName) {
      return agentColors[agentName] || { bg: 'bg-gray-500', text: 'text-gray-100', border: 'border-gray-400' };
    }

    function getAgentEmoji(agentName) {
      return agentEmojis[agentName] || 'ü§ñ';
    }

    // Timer update
    function updateTimer(seconds) {
      if (seconds <= 0) {
        timerElement.textContent = '00:00';
        return;
      }
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerElement.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      if (seconds <= 60) {
        timerElement.classList.add('text-red-400');
      }
    }

    // Add message with styling
    function addMessage(speaker, text, isSystem = false) {
      const div = document.createElement("div");
      div.className = "message-appear";
      
      if (isSystem) {
        div.className += " text-center p-4";
        div.innerHTML = `
          <div class="inline-block glass-effect rounded-lg px-6 py-3">
            <span class="text-green-300 font-semibold">‚ú® ${text}</span>
          </div>
        `;
      } else if (speaker === "You") {
        div.className += " flex justify-end";
        div.innerHTML = `
          <div class="max-w-[80%] glass-effect rounded-2xl rounded-tr-sm p-4 border border-yellow-400/30">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xl">üë§</span>
              <span class="font-bold text-yellow-300">${speaker}</span>
            </div>
            <div class="text-white">${text}</div>
          </div>
        `;
      } else {
        const style = getAgentStyle(speaker);
        const emoji = getAgentEmoji(speaker);
        div.className += " flex justify-start";
        div.innerHTML = `
          <div class="max-w-[80%] glass-effect rounded-2xl rounded-tl-sm p-4 border ${style.border}/30">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xl">${emoji}</span>
              <span class="font-bold ${style.text}">${speaker}</span>
            </div>
            <div class="text-white">${text}</div>
          </div>
        `;
      }
      
      conversationLog.appendChild(div);
      conversationLog.scrollTop = conversationLog.scrollHeight;
    }

    function updateStatus(msg) {
      statusMessage.textContent = msg;
      console.log('Status:', msg);
    }

    function displayAgents(agents) {
      agentsList.innerHTML = '';
      currentAgents = agents;
      
      agents.forEach(agentName => {
        const style = getAgentStyle(agentName);
        const emoji = getAgentEmoji(agentName);
        const agentDiv = document.createElement('div');
        agentDiv.className = `agent-avatar ${style.bg} ${style.text} px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2 shadow-lg`;
        agentDiv.innerHTML = `<span>${emoji}</span><span>${agentName}</span>`;
        agentsList.appendChild(agentDiv);
      });
    }

    // Audio playback with queue
    async function playAudioFromBase64(audioBase64) {
      return new Promise((resolve, reject) => {
        try {
          const binaryString = atob(audioBase64);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          
          const blob = new Blob([bytes], { type: 'audio/wav' });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          
          audio.onended = () => {
            URL.revokeObjectURL(url);
            resolve();
          };
          
          audio.onerror = (e) => {
            console.error('Audio playback error:', e);
            URL.revokeObjectURL(url);
            reject(e);
          };
          
          audio.play().catch(err => {
            console.error('Play error:', err);
            reject(err);
          });
          
        } catch (err) {
          console.error('Audio processing error:', err);
          reject(err);
        }
      });
    }

    async function processAudioQueue() {
      if (isPlayingAudio || audioQueue.length === 0) return;
      
      isPlayingAudio = true;
      const audioData = audioQueue.shift();
      
      // Highlight speaking agent
      const agentAvatars = agentsList.querySelectorAll('.agent-avatar');
      agentAvatars.forEach(avatar => {
        if (avatar.textContent.includes(audioData.agent)) {
          avatar.classList.add('ring-4', 'ring-white', 'scale-110');
        }
      });
      
      try {
        await playAudioFromBase64(audioData.audio);
      } catch (err) {
        console.error('Failed to play audio:', err);
      }
      
      // Remove highlight
      agentAvatars.forEach(avatar => {
        avatar.classList.remove('ring-4', 'ring-white', 'scale-110');
      });
      
      isPlayingAudio = false;
      processAudioQueue();
    }

    // Socket events
    socket.on("session_started", data => {
      console.log('Session started:', data);
      scenarioScreen.classList.add("hidden");
      conversationScreen.classList.remove("hidden");
      displayAgents(data.agents);
      addMessage("System", data.greeting, true);
      updateStatus("Ready - Hold the microphone to speak");
      
      // Show and start timer
      if (data.duration) {
        timerDisplay.classList.remove('hidden');
        sessionEndTime = Date.now() + (data.duration * 60 * 1000);
        updateTimerDisplay();
      }
    });

    function updateTimerDisplay() {
      if (!sessionEndTime) return;
      const remaining = Math.max(0, Math.floor((sessionEndTime - Date.now()) / 1000));
      updateTimer(remaining);
      if (remaining > 0) {
        setTimeout(updateTimerDisplay, 1000);
      }
    }

    socket.on("transcription", data => {
      console.log('Transcription received:', data.text);
      addMessage("You", data.text);
    });

    socket.on("agent_text", data => {
      console.log('Agent text:', data.agent, data.text);
      addMessage(data.agent, data.text);
    });

    socket.on("agent_response", data => {
      console.log('Agent response with audio:', data.agent);
      
      if (data.audio) {
        audioQueue.push({ agent: data.agent, audio: data.audio });
        processAudioQueue();
      }
      
      if (data.remaining_time !== undefined) {
        sessionEndTime = Date.now() + (data.remaining_time * 1000);
      }
    });

    socket.on("status", data => {
      updateStatus(data.message);
    });

    socket.on("error", data => {
      updateStatus("‚ùå " + data.message);
      console.error('Error:', data.message);
      recordOrb.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      setTimeout(() => {
        recordOrb.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
      }, 2000);
    });

    socket.on("session_expired", data => {
      updateStatus("‚è∞ " + data.message);
      recordOrb.style.pointerEvents = 'none';
      recordOrb.style.opacity = '0.5';
    });

    // Fetch rooms
    fetch("/api/rooms")
      .then(r => r.json())
      .then(data => {
        if (data.rooms) {
          data.rooms.forEach((room, idx) => {
            const btn = document.createElement("button");
            btn.className = "w-full p-4 glass-effect hover:bg-white/10 rounded-xl transition-all font-semibold text-white text-lg border border-white/20 hover:border-white/40 hover:scale-105";
            btn.innerHTML = `
              <div class="flex items-center justify-between">
                <span>üö™ ${room.name}</span>
                <span class="text-sm text-purple-300">${room.agents ? room.agents.length : 0} agents</span>
              </div>
            `;
            btn.onclick = () => {
              console.log('Starting session for room:', room.name);
              socket.emit("start_session", { room_index: idx });
            };
            roomSelection.appendChild(btn);
          });
        }
      })
      .catch(err => {
        console.error('Failed to load rooms:', err);
        updateStatus('Failed to load rooms');
      });

    // Recording
    async function startRecording() {
      if (isRecording) return;
      
      try {
        console.log('Starting recording...');
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            channelCount: 1,
            sampleRate: 16000,
            echoCancellation: true,
            noiseSuppression: true
          } 
        });
        
        const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
          console.log('Recording stopped, processing...');
          const blob = new Blob(audioChunks, { type: mimeType });
          
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64Audio = reader.result.split(",")[1];
            socket.emit("process_audio", { audio: base64Audio });
          };
          reader.readAsDataURL(blob);
          
          stream.getTracks().forEach(t => t.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordOrb.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        recordOrb.textContent = '‚è∫Ô∏è';
        pulseRing.classList.add('pulse-ring');
        pulseRing.style.opacity = '0.6';
        updateStatus("üé§ Recording... Release to send");
        
      } catch (err) {
        console.error('Failed to start recording:', err);
        updateStatus('‚ùå Microphone access denied');
      }
    }

    function stopRecording() {
      if (!isRecording) return;
      
      console.log('Stopping recording...');
      mediaRecorder.stop();
      isRecording = false;
      recordOrb.style.background = 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)';
      recordOrb.textContent = 'üé§';
      pulseRing.classList.remove('pulse-ring');
      pulseRing.style.opacity = '0';
      updateStatus("‚è≥ Processing your message...");
    }

    // Event listeners
    recordOrb.addEventListener("mousedown", startRecording);
    recordOrb.addEventListener("mouseup", stopRecording);
    recordOrb.addEventListener("mouseleave", () => {
      if (isRecording) stopRecording();
    });

    recordOrb.addEventListener("touchstart", (e) => {
      e.preventDefault();
      startRecording();
    });
    recordOrb.addEventListener("touchend", (e) => {
      e.preventDefault();
      stopRecording();
    });

    console.log('‚ú® AURA frontend initialized');
  </script>
</body>
</html>